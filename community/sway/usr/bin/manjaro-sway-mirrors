#!/bin/sh
pacman_conf=/etc/pacman.conf
custom_conf=/etc/pacman.d/manjaro-sway.repo.conf

if [ "$1" = "check" ]; then
    [ -f $custom_conf ] || exit 1
    grep -q "/$(pacman-mirrors -G)" $custom_conf >/dev/null 2>&1 || exit 1
    exit 0
fi

if [ "$EUID" -ne 0 ]; then
    echo "## Please run as root/sudo"
    exit 1
fi

curl -s https://pkg.manjaro-sway.download/$(pacman-mirrors -G)/ >$custom_conf

## remove the classic repo config
if grep -q "\[manjaro-sway\]" $pacman_conf; then
    sed -i '/\[manjaro-sway\]/,+2 d' $pacman_conf
    echo '## removed classic repo configuration from pacman.conf'
else
    echo '## classic repo configuration not present in pacman.conf'
fi

## add a include line to the pacman.conf
if grep -q "manjaro-sway.repo.conf" $pacman_conf; then
    echo '## already referencing manjaro-sway.repo.conf from pacman.conf'
else
    sed -i '/^\[core\]/i \Include = /etc/pacman.d/manjaro-sway.repo.conf\n' $pacman_conf
    echo '## now referencing manjaro-sway.repo.conf from pacman.conf'
fi

echo "## manjaro repo configured:"
cat $custom_conf
